<html>
    <head>
        <meta charset="UTF-8">
        <script src="https://d3js.org/d3.v4.js"></script>        
        <!--<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>-->
        <link  href="modules/views/html/lib/vis/dist/vis.css" rel="stylesheet">
        <script src="modules/views/html/lib/HackTimer.js"></script>
        <script src="modules/views/html/lib/jquery-1.11.3.js"></script>
        <script src="modules/views/html/lib/jquery.color-2.1.0.js"></script>
        <script src="modules/views/html/lib/ace/ace.js"></script>
        <script src="modules/views/html/lib/vis/dist/vis.js"></script>

        <link  href="modules/views/html/htmlBasics.css" rel="stylesheet">
        <script src="modules/views/html/htmlBasics.js"></script>

        <link  href="modules/views/html/primitive/primitive.css" rel="stylesheet">

        <link  href="modules/views/html/line/line.css" rel="stylesheet">
        <script src="modules/views/html/line/decorators.js"></script>
        <script src="modules/views/html/line/object-autoView.js"></script>
        <script src="modules/views/html/line/object-appendView.js"></script>
        <script src="modules/views/html/line/job-lineView.js"></script>
        <script src="modules/views/html/line/file-lineView.js"></script>

        <link  href="modules/views/html/d3/d3.css" rel="stylesheet">
        <script src="modules/views/html/d3/d3.js"></script>

        <link  href="modules/views/html/a5/a5.css" rel="stylesheet">
        <script src="modules/views/html/a5/decorators.js"></script>        
        <script src="modules/views/html/a5/job-d3gantView.js"></script>
        <script src="modules/views/html/a5/job-progressLineView.js"></script>
        <script src="modules/views/html/a5/job-progressTreeView.js"></script>
        <script src="modules/views/html/a5/job-runView.js"></script>
        <script src="modules/views/html/a5/job-visGantView.js"></script>
        <script src="modules/views/html/a5/job-visGraphView.js"></script>
        <script src="modules/views/html/a5/network-listView.js"></script>
        <script src="modules/views/html/a5/node-panelView.js"></script>
        <script src="modules/views/html/a5/object-a5lazyExpanderView.js"></script>
        <script src="modules/views/html/a5/object-autoView.js"></script>
        <script src="modules/views/html/a5/object-visGraphView.js"></script>
        <script src="modules/views/html/a5/object-d3treeView.js"></script>
        <script src="modules/views/html/a5/object-d3graphView.js"></script>
        <script src="modules/views/html/a5/project-editView.js"></script>

        <link  href="modules/jobs/workerModel3d.css" rel="stylesheet">

        <script src="modules/types/browserWsNetwork.js"></script>
        <script src="modules/types/project.js"></script>
        <script src="modules/types/projectFolder.js"></script>
        <script src="modules/types/pSet.js"></script>

        <script src="src/job/folder.js"></script>

        <script src="src/mvj.js"></script>
        <script src="src/q.js"></script>
        <script src="src/config.js"></script>
        <script src="src/tools.js"></script>
        <script src="src/messages.js"></script>
        <script src="src/sim.js"></script>
        <script src="src/app.js"></script>

        <!--<script src="src/network/browserWs.js"></script>-->

        <script src="src/job/job.js"></script>
        <script src="src/job/workflows.js"></script>
        <script src="src/job/toolJobs.js"></script>

        <script src="src/views/view.js"></script>
        <link  href="src/views/html/view.css" rel="stylesheet">
        <script src="src/views/html/client.js"></script>

    </head>
    <!--<body id="body" onload="app.init({
            type:'C',
            nodeId:'C₀',
            userId:'M',
            wsUrl:'ws://' + document.location.hostname + ':' + config.server.wsport,
            onInit:onInit
        })"> -->
    <body id="body" onload="app.initC({

        builtInTypes:{
            'Folder':Folder,
            'Folder<Mod>':ModuleFolder,
            'File<Mod>':FileMod,
            'Set<View>':ViewSet,
            'Network':wsBrowser,
        },

        structure:{
            type:'C',
            host:'Browser',
            //userId:'M',            
            //nodeId:'C₀',
            '+1 client': j=> {
                window.open('./view.html', '_blank')
                j.ret('ok', 'window.open(...) called')
            },
            registry:{
                config:config,
                views:{
                    primitiveBound:{
                        type:'Folder<Mod>',
                        directory:'./modules/views/html/primitive/'
                    }
                }
            },
            network:{
                type: 'Network',
                endpoint:'ws://' + document.location.hostname + ':' + config.server.wsport,
                '+4 worker': j=> app.model.mods.lib['🖥 Start workers']['▸'](j),
                '☠ worker': j=> app.model.mods.lib['☠ Kill all']['▸'](j, {}, { nodeType:['Worker']}),
                '☠ all': j=> app.model.mods.lib['☠ Kill all']['▸'](j, {}, { nodeType:['Server', 'Overlord', 'Worker']}),
                '↻ clients': j=> {
                    app.network['S₀'].send({
                        type:'Ws',
                        payload:messages.reloadMsg()
                    })
                    j.ret('ok', 'reload message sent')
                },
                stateChangeHandlers:{
                    onConnected:    c=> {},
                    onDisconnected: c=> cleanUpAllConnections(c)
                },
                msgHandlers:{
                    onNetworkInfo: (c, parsed)=> app.mergePath(parsed.path, parsed.diff),
                    onReload:      (c, parsed)=> location.reload(true),
                    onServerHallo: (c, parsed)=> onServerHallo(null, 'Client', ['JS'], c, parsed, 'Browser', '')
                }
            }
        },

        onInit:j=> j.delegate(
            ()=> jf.job({
                icon:'≟',
                desc:'prepare client',
                params:{},
                onCall:j1=> {
                    $('#modelTabPaper').append(tab('modelTab'))
                    $('#jobTabPaper').append(tab('jobTab'))
                    app.clientId.on('change', changes=> {                        
                        jf.host = 'Browser'
                        document.title = app.workerId()
                        $('#thisId').text(app.workerId())
                    })
                    j1.ret('ok', 'ui loaded')
                }
            }),
            ()=> jf.job({
                icon:'≟',
                desc:'connect',
                params:{},
                onCall:j1=> app.network['⛓'](j1)
            }),
            ()=> jf.job({
                icon:'≟',
                desc:'load views',
                params:{},
                output:app.registry.views.primitiveBound,
                onCall:j1=> app.registry.views.primitiveBound['↻'](j1),
            }),
            ()=> jf.job({
                icon:'≟',
                desc:'showui',
                params:{},
                onCall:j1=>{
                    var projectsDiv = document.createElement('div')
                    projectsDiv.appendChild(a3View(app.model.mods))
                    projectsDiv.appendChild(a3View(app.network))
                    $('#modelTab')[0].add('☍', { content:a3View(app) })
                    $('#modelTab')[0].add('🌐', { content:projectsDiv }, 'inBg')
                    $('#modelTab')[0].add('⥂', { content:a3View(app.model.jobs) }, 'inBg')
                    $('#jobTab')[0].add(j.id, { content:a3View(j) })
                    j1.ret('ok', 'ui loaded')
                }
            })
        )
    })">

        <div id="workspace">
            <div id="modelTabPaper" class="paper" style="float:left;"></div>            
            <div id="jobTabPaper" class="paper" style="float:left;"></div>            
        </div>
        <div id="footer">
            <div id="thisId"></div>
            <a href="doc/bsc/Abschlussarbeit.pdf">
                <div id="connectionState"></div>
                <div id="connectionDate"></div>
            </a>
        </div>
    </body>
</html>
